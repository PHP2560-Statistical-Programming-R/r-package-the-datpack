---
title: "Epi Package"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Link to shiny with leaflet example:
https://rstudio.github.io/leaflet/shiny.html 

Link to mapping examples: 
https://cran.r-project.org/web/packages/usmap/vignettes/mapping.html

Link to names of Fatalities Variables:
https://github.com/cran/AER/blob/master/man/Fatalities.Rd 

Ideas:
1.) Create a function to map incidence on state level
2.) Create a function to map incidence on based on region
3.) Create a function to map incidence nationally


```{r}
library(MASS)
library(epiR)
library(epitools)
library(incidence)
library(Epi)
library(epiDisplay)
library(devtools)
library(roxygen2)
library(epicalc)
library(maps)
library(usmap)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(rprev)
library(ggmap)
library(mapdata)
library(viridis)
```

#Load sample dataset available in the AER package
```{r}
library(AER)
data(Fatalities)
```


#Example code for national fatalities
```{r}
plot_usmap(data = Fatalities, values = "fatal", lines = "red") + 
  scale_fill_continuous(name = "Fatalities", label = scales::comma) + 
  theme(legend.position = "right")
```

#Map of Northeast
```{r}
plot_usmap(data = Fatalities, values = "fatal", include =c("MA","RI","CT","ME","VT","NH","NY","NJ","PA"), lines = "black") + 
  scale_fill_continuous(low = "white", high = "dark blue", name = "fatalities", label = scales::comma) + labs(title = "Northeast US States") + theme(legend.position = "right")
```
The Northeast includes Maine, New Hampshire, Vermont, Massachusetts, Rhode Island, Connecticut, New York, New Jersey, and Pennsylvania

#Map of South 
```{r}
plot_usmap(data = Fatalities, values = "fatal", include =c("DE","MD","WV","VA","KY","TN","NC","SC","GA","AL","MS","AR","LA","FL","TX","OK"), lines = "black") + scale_fill_continuous(low = "white", high = "dark green", name = "fatalities", label = scales::comma) + labs(title = "Southern US States") + theme(legend.position = "right")
```
The South claims more states than any other region: Delaware, Maryland, Virginia, West Virginia, Kentucky, North Carolina, South Carolina, Tennessee, Georgia, Florida, Alabama, Mississippi, Arkansas, Louisiana, Texas, and Oklahoma.

#Map of Midwest
```{r}
plot_usmap(data = Fatalities, values = "fatal", include =c("OH","MI","IN","WI","IL","MN","IA","MO","ND","SD","NE","KS"), lines = "black") + 
  scale_fill_continuous(low = "white", high = "pink", name = "fatalities", label = scales::comma
  ) + labs(title = "Midwest US States") + theme(legend.position = "right")
```
The Midwest consists of Ohio, Michigan, Indiana, Wisconsin, Illinois, Minnesota, Iowa, Missouri, North Dakota, South Dakota, Nebraska, and Kansas.

#Map of West Coast
```{r}
plot_usmap(data = Fatalities, values = "fatal", include = c("MT","WY","CO","NM","AZ","UT","CA", "ID", "NV", "OR", "WA"), lines = "black") + 
  scale_fill_continuous(low = "white", high = "sky blue", name = "Fatalities", label = scales::comma) + 
  labs(title = "Western US States") + theme(legend.position = "right")
```
The West comprises Montana, Idaho, Wyoming, Colorado, New Mexico, Arizona, Utah, Nevada, California, Oregon, Washington, Alaska, and Hawaii.

##NOTE: no data for Alaska or Hawaii

To do: 
Write function for mapping (state, national)
within the function, have it first calculate incidence/prevalence, etc. from a predefined previous function

#Function to Write
```{r}
map_prevalence <- function(data,state,year,existing_cases,population) {
  data %>%
    group_by(state,year) %>%
  prevalence = existing_cases / population  #a number of cases, b is pop
  return(prevalence)
   #t<- all years or one year
     if (state == "al") {
 plot_usmap(data = Fatalities, values = prevalence, include = state, lines = "black") + 
  scale_fill_continuous(low = "white", high = "dark blue", name = "fatalities", label = scales::comma) + labs(title = "Alabama") + theme(legend.position = "right")
     }
  else {
    break
  }
}

map_prevalence(Fatalities,state="al",year="1982",existing_cases= "fatal",population= "pop")
```

#Alternative (No if loop for state) Good one
```{r}
map_prevalence <- function(data,existing_cases,population,state,year) {
  
  data %>%
    group_by(!! sym(state), !! sym(year)) %>%
    mutate(prevalence = !! sym(existing_cases) / !!sym(population)) %>%
 plot_usmap(data = Fatalities, values = prevalence, include = state, lines = "black") + 
  scale_fill_continuous(low = "white", high = "dark blue", name = "fatalities", label = scales::csomma) + labs(title = "State") + theme(legend.position = "right")
}

map_prevalence(Fatalities,existing_cases= "fatal",population="pop",state="al",year="1982")

map_prevalence(Fatalities,existing_cases= "fatal",population="pop",state="state",year="year")
```

#National 
```{r}
map_prevalence <- function(data,state,year,existing_cases,population) {
  data %>%
    group_by(state,year) %>%
    mutate(prevalence = existing_cases / population) 
    for (i in 1:length(state)) 
      if (state=="all") {
 national<-plot_usmap(data = Fatalities, values = "prevalence", include = "state", lines = "black") + 
  scale_fill_continuous(low = "white", high = "dark blue", name = "fatalities", label = scales::csomma) + labs(title = "National") + theme(legend.position = "right")
      }
  else {
    break 
  }
}

map_prevalence(Fatalities,state="all",year="1982",existing_cases= "fatal",population= "pop")
```


#Working ggmap graph
```{r}
us_map <- map_data("state")

tbl <- state.x77 %>%
  as_tibble(rownames = "state") %>%
  bind_cols(state_name = str_to_lower(state.abb)) %>%
  rename(value_x = Income) %>%
  select(state_name, value_x)

state_abbs <- tibble(state_full = str_to_lower(state.name), abb = str_to_lower(state.abb))
tbl_m <- left_join(tbl, state_abbs, by = c("state_name" = "abb")) %>%
  rename(id = state_full)

Fatalities %>%
  left_join(state_abbs, by = c("state" = "abb")) %>%
  right_join(us_map, by = c("state_full" = "region")) %>%
  ggplot(aes(x = long, y = lat, group = group, fill = `fatal`)) +
  geom_polygon(color = "white") + ggtitle("National Fatalities 1982-1988") +
  theme_void() + 
  scale_fill_viridis(name = "Fatalities (Count)") 
```



#Sample Function: Working!! 
```{r}
map_national_prevalence <- function(data,existing_cases,population,state,year) {
  data %>%
    group_by(!! sym(state), !! sym(year)) %>%
    mutate(prevalence = !! sym(existing_cases) / !!sym(population)) %>%
  left_join(state_abbs, by = c("state" = "abb")) %>%
  right_join(us_map, by = c("state_full" = "region")) %>%
  ggplot(aes(x = long, y = lat, group = group, fill = `prevalence`)) +
  geom_polygon(color = "white") + ggtitle("National Prevalence of Car Fatalities 1982-1988") +
  theme_void() + 
  scale_fill_viridis(name = "Prevalence")
}

map_national_prevalence(Fatalities,existing_cases= "fatal",population="pop", state="state", year="year")
```

#Mapping for Specific Year
```{r}
map_national_prevalence <- function(data,existing_cases,population,state,year,specific_year) {
  data %>%
    group_by(!! sym(state), !! sym(year)) %>%
  mutate(prevalence = !! sym(existing_cases) / !!sym(population),
         specific_year = distinct(!! sym(year))) %>%
  filter(!! sym(year) == specific_year) %>%
      
  left_join(state_abbs, by = c("state" = "abb")) %>%
  right_join(us_map, by = c("state" = "region")) %>%
  ggplot(aes(x = long, y = lat, group = group, fill = `prevalence`)) +
  geom_polygon(color = "white") + ggtitle("National Prevalence of Car Fatalities 1982-1988") +
  theme_void() + 
  scale_fill_viridis(name = "Prevalence")
}

map_national_prevalence(Fatalities,existing_cases="fatal",population="pop",state="state",year="year",specific_year == "1982")
```

Notes:
get ggmaps package 
check our stargazer package to generate a nice output
explain arguments 
write function to add column names to refer to the dataset variables we want (state, year, population) 
survey package in R good example
join of state name and state abbreviation and keep state abbreviation
vignette: include links and cite other things (for more further details see...)

Shiny App:
-drag by year (see changes in incidence of prevalence across years:by state or country)
-creating a reactive dataset 

-identify one state or one year: 
filter step (unique state)
filter year (unique year)
specific_state in argument
specific_year in argument


